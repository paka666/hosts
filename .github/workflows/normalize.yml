name: Normalize Files (UTF-8 + LF)
on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 20 * * *"
  workflow_dispatch:
jobs:
  normalize:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set Git config
        run: |
          git config --global core.autocrlf input
          git config --global core.eol lf
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
      - name: Ensure .gitattributes exists (LF policy)
        run: |
          if [ ! -f .gitattributes ]; then
            echo '* text eol=lf' > .gitattributes
          elif ! grep -q 'text eol=lf' .gitattributes; then
            echo '* text eol=lf' >> .gitattributes
          fi
          # é¢å¤–æ·»åŠ å¯¹äºŒè¿›åˆ¶æ–‡ä»¶çš„å¤„ç†ï¼ˆé¿å…è¯¯å¤„ç†éæ–‡æœ¬æ–‡ä»¶ï¼‰
          echo '*.png binary' >> .gitattributes
          echo '*.jpg binary' >> .gitattributes
          echo '*.gif binary' >> .gitattributes
          echo '*.pdf binary' >> .gitattributes
          echo '*.zip binary' >> .gitattributes
          # å¯ä»¥æ ¹æ®ä»“åº“éœ€è¦æ·»åŠ æ›´å¤šäºŒè¿›åˆ¶ç±»å‹
      - name: Install encoding tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y dos2unix enca file
      - name: Normalize text files to UTF-8 + LF
        shell: bash
        run: |
          echo "ğŸ” Determining scan scope based on trigger..."
          files=()
          changed_files=()
          trigger="${{ github.event_name }}"
          
          if [ "$trigger" = "push" ]; then
            echo "ğŸ“¥ Push detected: Scanning only changed files in this commit."
            # è·å–æœ¬æ¬¡ push/commit ä¸­å˜æ›´çš„æ–‡ä»¶ï¼ˆåŒ…æ‹¬æ·»åŠ /ä¿®æ”¹/é‡å‘½åï¼‰
            git diff --name-only HEAD~1 > changed_files.txt || echo "No previous commit; scanning all." && git ls-files > changed_files.txt
            while IFS= read -r f; do
              if [ -f "$f" ]; then  # åªå¤„ç†å­˜åœ¨çš„æ–‡ä»¶
                changed_files+=("$f")
              fi
            done < changed_files.txt
            rm -f changed_files.txt
            scan_list=("${changed_files[@]}")
          else
            echo "ğŸ› ï¸ Manual/scheduled run: Scanning entire repository."
            scan_list=($(find . -type f \
              -not -path "./.git/*" \
              -not -path "./node_modules/*" \
              -not -path "./venv/*"))
          fi
          
          echo "ğŸ“‚ Files to scan: ${#scan_list[@]}"
          for f in "${scan_list[@]}"; do
            # æ£€æŸ¥æ˜¯å¦ä¸ºæ–‡æœ¬æ–‡ä»¶ï¼ˆæ’é™¤äºŒè¿›åˆ¶ï¼‰
            if file "$f" | grep -qE "text|script|source|ASCII|UTF-8" && ! file "$f" | grep -q "executable"; then
              modified=false
              # æ£€æµ‹ç¼–ç 
              encoding=$(file -bi "$f" | sed -n 's/.*charset=\(.*\)$/\1/p')
              if [ "$encoding" != "utf-8" ] && [ "$encoding" != "us-ascii" ] && [ "$encoding" != "unknown-8bit" ]; then
                echo "ğŸ§© Converting $f from $encoding â†’ UTF-8"
                iconv -f "$encoding" -t utf-8 "$f" -o "$f.tmp" && mv "$f.tmp" "$f" || echo "âš ï¸ Failed to convert $f (unsupported encoding?)" >&2
                modified=true
              fi
              # è½¬æ¢ä¸º LF è¡Œå°¾
              if dos2unix "$f" 2>/dev/null; then
                modified=true
              fi
              # éªŒè¯è½¬æ¢åæ— ä¹±ç ï¼ˆç®€å•æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å¯è¯»ï¼‰
              if ! file "$f" | grep -q "UTF-8"; then
                echo "âš ï¸ Potential garbled content in $f after conversion" >&2
              fi
              if [ "$modified" = true ]; then
                files+=("$f")
              fi
            fi
          done
          
          # æ˜¾ç¤ºä¿®å¤çš„æ–‡ä»¶
          if [ ${#files[@]} -gt 0 ]; then
            echo "âœ… Fixed files:"
            for file in "${files[@]}"; do
              echo "- $file"
            done
          else
            echo "âœ… No files needed fixing."
          fi
          
          # åªå¯¹å¤„ç†è¿‡çš„æ–‡ä»¶è¿›è¡Œ renormalize å’Œ addï¼ˆé¿å…ä¸å¿…è¦å˜æ›´ï¼‰
          if [ ${#files[@]} -gt 0 ]; then
            git add --renormalize "${files[@]}"
            git add "${files[@]}"
          fi
      - name: Git commit & push
        run: |
          if ! git diff --cached --quiet; then
            git commit -m "Auto-normalize files to UTF-8 + LF (fix encoding/line endings in changed files)"
            git push
            echo "âœ… Normalization done and pushed. Files updated for GitHub compatibility (no garbled text)."
          else
            echo "âœ… No issues found; everything already normalized."
          fi
      - name: Handle errors gracefully
        if: ${{ failure() }}
        run: echo "âŒ Normalization encountered issues; check logs for details."
