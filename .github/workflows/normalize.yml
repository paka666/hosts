name: Normalize Files (UTF-8 + LF)

on:
  push:
  workflow_dispatch:

jobs:
  normalize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Git config
        run: |
          git config --global core.autocrlf input
          git config --global core.eol lf
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Ensure .gitattributes exists (LF policy)
        run: |
          if [ ! -f .gitattributes ]; then
            echo '* text eol=lf' > .gitattributes
          elif ! grep -q 'text eol=lf' .gitattributes; then
            echo '* text eol=lf' >> .gitattributes
          fi

      - name: Install encoding tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y dos2unix enca file

      - name: Normalize all text files to UTF-8 + LF
        shell: bash
        run: |
          echo "ðŸ” Scanning files for encoding and line endings..."
          find . -type f \
            -not -path "./.git/*" \
            -not -path "./.github/*" \
            -not -path "./node_modules/*" \
            -not -path "./venv/*" \
            | while read -r f; do
              if file "$f" | grep -qE "text|script|source"; then
                encoding=$(file -bi "$f" | sed -n 's/.*charset=\(.*\)$/\1/p')
                if [ "$encoding" != "utf-8" ] && [ "$encoding" != "us-ascii" ]; then
                  echo "ðŸ§© Converting $f from $encoding â†’ UTF-8"
                  iconv -f "$encoding" -t utf-8 "$f" -o "$f.tmp" && mv "$f.tmp" "$f"
                fi
                dos2unix "$f" 2>/dev/null || true
              fi
            done

      - name: Git normalize commit & push
        run: |
          git add --renormalize .
          if ! git diff --cached --quiet; then
            git commit -m "Normalize all files to UTF-8 + LF (auto)"
            git push
            echo "âœ… Normalization done and pushed."
          else
            echo "âœ… Everything already normalized."
          fi